<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¼‚æ¬¡å…ƒ AI åŠ©æ‰‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Oxanium:wght@300;400;600&display=swap');
        
        body {
            font-family: 'Oxanium', sans-serif;
            background: #0a0a16;
            color: #e0e0ff;
            overflow-x: hidden;
        }
        
        .stranger-things-bg {
            background: 
                radial-gradient(circle at 20% 30%, rgba(75, 0, 130, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(0, 100, 200, 0.2) 0%, transparent 50%),
                linear-gradient(135deg, #0a0a16 0%, #1a1a2e 50%, #0a0a16 100%);
            position: relative;
        }
        
        .stranger-things-bg::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0, 100, 200, 0.05) 2px, rgba(0, 100, 200, 0.05) 4px),
                repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(75, 0, 130, 0.05) 2px, rgba(75, 0, 130, 0.05) 4px);
            pointer-events: none;
            z-index: 0;
        }
        
        .stranger-header {
            background: rgba(10, 10, 22, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0, 100, 200, 0.3);
            box-shadow: 0 0 20px rgba(0, 100, 200, 0.2);
        }
        
        .stranger-title {
            font-family: 'Orbitron', monospace;
            font-weight: 700;
            background: linear-gradient(90deg, #ff0080, #8000ff, #0080ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 10px rgba(255, 0, 128, 0.5);
            letter-spacing: 1px;
        }
        
        .stranger-badge {
            background: linear-gradient(135deg, #ff0080, #8000ff);
            color: white;
            font-family: 'Orbitron', monospace;
            font-size: 0.7rem;
            letter-spacing: 1px;
            box-shadow: 0 0 10px rgba(255, 0, 128, 0.5);
        }
        
        .message-container {
            scrollbar-width: thin;
            scrollbar-color: #4a00e0 #0a0a16;
        }
        
        .message-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .message-container::-webkit-scrollbar-track {
            background: #0a0a16;
        }
        
        .message-container::-webkit-scrollbar-thumb {
            background-color: #4a00e0;
            border-radius: 3px;
        }
        
        .user-message {
            animation: slideInRight 0.4s ease-out;
        }
        
        .ai-message {
            animation: slideInLeft 0.4s ease-out;
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .message-bubble {
            border-radius: 18px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .user-bubble {
            background: linear-gradient(135deg, #ff0080 0%, #8000ff 100%);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .ai-bubble {
            background: rgba(20, 20, 40, 0.7);
            border: 1px solid rgba(0, 100, 200, 0.3);
            color: #ffffff;
            backdrop-filter: blur(5px);
        }
        
        .input-container {
            background: rgba(20, 20, 40, 0.7);
            border: 1px solid rgba(0, 100, 200, 0.3);
            backdrop-filter: blur(5px);
        }
        
        .input-container:focus-within {
            box-shadow: 0 0 0 2px rgba(0, 100, 200, 0.5);
            border-color: rgba(0, 100, 200, 0.7);
            transition: all 0.3s ease;
        }
        
        .send-button {
            background: linear-gradient(135deg, #ff0080, #8000ff);
            transition: all 0.3s ease;
            box-shadow: 0 0 15px rgba(255, 0, 128, 0.4);
        }
        
        .send-button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255, 0, 128, 0.6);
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        .typing-indicator {
            display: inline-block;
            position: relative;
            width: 80px;
            height: 30px;
        }
        
        .typing-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #8e2de2;
            position: absolute;
            animation: typing 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) {
            left: 0;
            animation-delay: 0s;
        }
        
        .typing-dot:nth-child(2) {
            left: 20px;
            animation-delay: 0.2s;
        }
        
        .typing-dot:nth-child(3) {
            left: 40px;
            animation-delay: 0.4s;
        }
        
        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                background-color: #8e2de2;
            }
            30% {
                transform: translateY(-10px);
                background-color: #ff0080;
            }
        }
        
        .api-key-input {
            background: rgba(20, 20, 40, 0.7);
            border: 1px solid rgba(0, 100, 200, 0.3);
            color: #e0e0ff;
            transition: all 0.3s ease;
        }
        
        .api-key-input:focus {
            box-shadow: 0 0 0 2px rgba(0, 100, 200, 0.5);
            border-color: rgba(0, 100, 200, 0.7);
        }
        
        .api-key-input::placeholder {
            color: #8a8ac4;
        }
        
        .stranger-panel {
            background: rgba(20, 20, 40, 0.8);
            border: 1px solid rgba(0, 100, 200, 0.3);
            backdrop-filter: blur(10px);
        }
        
        .stranger-select {
            background: rgba(20, 20, 40, 0.7);
            border: 1px solid rgba(0, 100, 200, 0.3);
            color: #e0e0ff;
        }
        
        .stranger-select option {
            background: #1a1a2e;
            color: #e0e0ff;
        }
        
        /* è®¾ç½®é¢æ¿æ ·å¼ */
        #settingsPanel {
            display: none;
            transition: all 0.3s ease;
        }
        
        #settingsPanel.open {
            display: block;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.open {
            display: flex;
        }
        
        .modal-content {
            background: rgba(20, 20, 40, 0.95);
            border: 1px solid rgba(0, 100, 200, 0.5);
            border-radius: 12px;
            padding: 24px;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 0 30px rgba(0, 100, 200, 0.3);
            max-height: 80vh;
            overflow-y: auto;
            backdrop-filter: blur(10px);
        }
        
        .api-test-btn {
            background: linear-gradient(135deg, #ff0080, #8000ff);
            transition: all 0.3s ease;
            box-shadow: 0 0 10px rgba(255, 0, 128, 0.3);
        }
        
        .api-test-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 15px rgba(255, 0, 128, 0.5);
        }
        
        .test-success {
            background: linear-gradient(135deg, #00b09b, #96c93d);
            color: white;
        }
        
        .test-failure {
            background: linear-gradient(135deg, #ff416c, #ff4b2b);
            color: white;
        }
        
        .api-guide {
            background: rgba(0, 100, 200, 0.1);
            border-left: 4px solid #0080ff;
        }
        
        .model-info {
            background: rgba(0, 100, 200, 0.1);
            border-radius: 8px;
            padding: 12px;
            margin-top: 8px;
            font-size: 0.75rem;
            border: 1px solid rgba(0, 100, 200, 0.2);
        }
        
        .model-tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            margin-right: 6px;
            margin-bottom: 4px;
        }
        
        .tag-general {
            background: rgba(0, 100, 200, 0.3);
            color: #8ac6ff;
        }
        
        .tag-reasoning {
            background: rgba(0, 200, 100, 0.3);
            color: #8affc6;
        }
        
        .tag-latest {
            background: rgba(150, 0, 200, 0.3);
            color: #d08aff;
        }
        
        .tag-experimental {
            background: rgba(200, 100, 0, 0.3);
            color: #ffc68a;
        }
        
        .token-info {
            background: rgba(200, 150, 0, 0.2);
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 0.75rem;
            margin-top: 8px;
            border: 1px solid rgba(200, 150, 0, 0.3);
        }
        
        .glitch-text {
            position: relative;
            display: inline-block;
        }
        
        .glitch-text::before,
        .glitch-text::after {
            content: attr(data-text);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        .glitch-text::before {
            left: 2px;
            text-shadow: -2px 0 #ff0080;
            clip: rect(44px, 450px, 56px, 0);
            animation: glitch-anim 5s infinite linear alternate-reverse;
        }
        
        .glitch-text::after {
            left: -2px;
            text-shadow: -2px 0 #00ffff;
            clip: rect(44px, 450px, 56px, 0);
            animation: glitch-anim2 5s infinite linear alternate-reverse;
        }
        
        @keyframes glitch-anim {
            0% {
                clip: rect(31px, 9999px, 15px, 0);
            }
            5% {
                clip: rect(64px, 9999px, 63px, 0);
            }
            10% {
                clip: rect(20px, 9999px, 45px, 0);
            }
            15% {
                clip: rect(18px, 9999px, 77px, 0);
            }
            20% {
                clip: rect(83px, 9999px, 58px, 0);
            }
            25% {
                clip: rect(55px, 9999px, 39px, 0);
            }
            30% {
                clip: rect(12px, 9999px, 12px, 0);
            }
            35% {
                clip: rect(57px, 9999px, 43px, 0);
            }
            40% {
                clip: rect(47px, 9999px, 3px, 0);
            }
            45% {
                clip: rect(25px, 9999px, 22px, 0);
            }
            50% {
                clip: rect(30px, 9999px, 57px, 0);
            }
            55% {
                clip: rect(83px, 9999px, 37px, 0);
            }
            60% {
                clip: rect(47px, 9999px, 63px, 0);
            }
            65% {
                clip: rect(81px, 9999px, 75px, 0);
            }
            70% {
                clip: rect(59px, 9999px, 74px, 0);
            }
            75% {
                clip: rect(12px, 9999px, 38px, 0);
            }
            80% {
                clip: rect(89px, 9999px, 20px, 0);
            }
            85% {
                clip: rect(43px, 9999px, 72px, 0);
            }
            90% {
                clip: rect(24px, 9999px, 59px, 0);
            }
            95% {
                clip: rect(82px, 9999px, 40px, 0);
            }
            100% {
                clip: rect(64px, 9999px, 29px, 0);
            }
        }
        
        @keyframes glitch-anim2 {
            0% {
                clip: rect(65px, 9999px, 100px, 0);
            }
            5% {
                clip: rect(52px, 9999px, 74px, 0);
            }
            10% {
                clip: rect(79px, 9999px, 85px, 0);
            }
            15% {
                clip: rect(75px, 9999px, 5px, 0);
            }
            20% {
                clip: rect(67px, 9999px, 61px, 0);
            }
            25% {
                clip: rect(14px, 9999px, 79px, 0);
            }
            30% {
                clip: rect(1px, 9999px, 66px, 0);
            }
            35% {
                clip: rect(86px, 9999px, 30px, 0);
            }
            40% {
                clip: rect(23px, 9999px, 98px, 0);
            }
            45% {
                clip: rect(85px, 9999px, 72px, 0);
            }
            50% {
                clip: rect(71px, 9999px, 75px, 0);
            }
            55% {
                clip: rect(2px, 9999px, 48px, 0);
            }
            60% {
                clip: rect(30px, 9999px, 16px, 0);
            }
            65% {
                clip: rect(59px, 9999px, 50px, 0);
            }
            70% {
                clip: rect(41px, 9999px, 62px, 0);
            }
            75% {
                clip: rect(2px, 9999px, 82px, 0);
            }
            80% {
                clip: rect(47px, 9999px, 73px, 0);
            }
            85% {
                clip: rect(3px, 9999px, 27px, 0);
            }
            90% {
                clip: rect(40px, 9999px, 17px, 0);
            }
            95% {
                clip: rect(22px, 9999px, 38px, 0);
            }
            100% {
                clip: rect(53px, 9999px, 49px, 0);
            }
        }
        
        .pulse-glow {
            animation: pulse-glow 2s infinite;
        }
        
        @keyframes pulse-glow {
            0% {
                box-shadow: 0 0 5px rgba(0, 100, 200, 0.5);
            }
            50% {
                box-shadow: 0 0 20px rgba(0, 100, 200, 0.8);
            }
            100% {
                box-shadow: 0 0 5px rgba(0, 100, 200, 0.5);
            }
        }
        
        /* æ—¶é’Ÿæ ·å¼ */
        .digital-clock {
            font-family: 'Orbitron', monospace;
            font-size: 1.2rem;
            background: linear-gradient(135deg, #ff0080, #8000ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 10px rgba(255, 0, 128, 0.5);
            padding: 5px 10px;
            border-radius: 8px;
            border: 1px solid rgba(255, 0, 128, 0.3);
            box-shadow: 0 0 15px rgba(255, 0, 128, 0.2);
            letter-spacing: 2px;
        }
        
        .clock-container {
            display: flex;
            align-items: center;
            margin-left: auto;
            margin-right: 20px;
        }
        
        .clock-label {
            font-size: 0.8rem;
            color: #8a8ac4;
            margin-right: 8px;
            font-family: 'Oxanium', sans-serif;
        }
        
        /* å›¾ç‰‡ä¸Šä¼ æ ·å¼ */
        .image-upload-btn {
            background: linear-gradient(135deg, #0080ff, #00ff80);
            transition: all 0.3s ease;
            box-shadow: 0 0 10px rgba(0, 128, 255, 0.3);
        }
        
        .image-upload-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(0, 128, 255, 0.5);
        }
        
        .voice-btn {
            background: linear-gradient(135deg, #ff8000, #ff0080);
            transition: all 0.3s ease;
            box-shadow: 0 0 10px rgba(255, 128, 0, 0.3);
        }
        
        .voice-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(255, 128, 0, 0.5);
        }
        
        .voice-btn.recording {
            background: linear-gradient(135deg, #ff0000, #ff4000);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(255, 0, 0, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(255, 0, 0, 0);
            }
        }
        
        .uploaded-image {
            max-width: 300px;
            max-height: 200px;
            border-radius: 8px;
            margin-top: 8px;
            border: 2px solid rgba(0, 100, 200, 0.5);
            box-shadow: 0 0 10px rgba(0, 100, 200, 0.3);
        }
        
        .image-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 8px;
        }
        
        .image-preview {
            position: relative;
            display: inline-block;
        }
        
        .remove-image {
            position: absolute;
            top: -8px;
            right: -8px;
            background: rgba(255, 0, 0, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .file-input {
            display: none;
        }
        
        .input-tools {
            display: flex;
            gap: 8px;
            margin-right: 8px;
        }
        
        .tool-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .built-in-key-notice {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid rgba(76, 175, 80, 0.5);
            border-radius: 6px;
            padding: 8px 12px;
            margin-top: 8px;
            font-size: 0.75rem;
            color: #81c784;
        }
        
        .rate-limit-notice {
            background: rgba(255, 152, 0, 0.2);
            border: 1px solid rgba(255, 152, 0, 0.5);
            border-radius: 6px;
            padding: 8px 12px;
            margin-top: 8px;
            font-size: 0.75rem;
            color: #ffb74d;
        }
        
        .context-badge {
            background: rgba(156, 39, 176, 0.3);
            border: 1px solid rgba(156, 39, 176, 0.5);
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 0.6rem;
            color: #ce93d8;
            margin-left: 8px;
        }
        
        .context-controls {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        
        .context-btn {
            background: rgba(100, 100, 200, 0.3);
            border: 1px solid rgba(100, 100, 200, 0.5);
            color: #a5b4fc;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .context-btn:hover {
            background: rgba(100, 100, 200, 0.5);
        }
    </style>
</head>
<body class="h-screen flex flex-col fade-in stranger-things-bg">
    <!-- ä½¿ç”¨æŒ‡å—æ¨¡æ€æ¡† -->
    <div id="guideModal" class="modal">
        <div class="modal-content">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-white">å¼‚æ¬¡å…ƒ AI åŠ©æ‰‹ä½¿ç”¨æŒ‡å—</h3>
                <button id="closeGuide" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div class="api-guide p-4 rounded-lg">
                    <h4 class="font-semibold text-blue-300 mb-2">ğŸ¯ ä¸Šä¸‹æ–‡è®°å¿†åŠŸèƒ½</h4>
                    <p class="text-sm text-gray-300">AIä¼šè®°ä½æ•´ä¸ªå¯¹è¯çš„ä¸Šä¸‹æ–‡ï¼Œæœ€å¤šä¿ç•™20è½®å¯¹è¯è®°å¿†</p>
                </div>
                
                <div class="api-guide p-4 rounded-lg">
                    <h4 class="font-semibold text-blue-300 mb-2">ğŸš€ åŠŸèƒ½è¯´æ˜</h4>
                    <div class="mt-2 text-xs text-gray-400 space-y-1">
                        <p><strong>ğŸ§  ä¸Šä¸‹æ–‡è®°å¿†:</strong> AIä¼šè®°ä½ä¹‹å‰çš„å¯¹è¯å†…å®¹</p>
                        <p><strong>ğŸ“· å›¾ç‰‡ä¸Šä¼ :</strong> æ”¯æŒå›¾ç‰‡åˆ†æå’Œè®°å¿†</p>
                        <p><strong>ğŸ¤ è¯­éŸ³è¾“å…¥:</strong> è¯­éŸ³è½¬æ–‡å­—è¾“å…¥</p>
                        <p><strong>â° å®æ—¶æ—¶é’Ÿ:</strong> é¡¶éƒ¨æ˜¾ç¤ºå½“å‰æ—¶é—´</p>
                    </div>
                </div>
                
                <div class="bg-green-900 bg-opacity-30 border border-green-700 rounded-lg p-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fas fa-brain text-green-400"></i>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-green-300">ä¸Šä¸‹æ–‡è®°å¿†</h3>
                            <div class="mt-2 text-sm text-green-200">
                                <p>AIä¼šè®°ä½æ•´ä¸ªå¯¹è¯å†å²ï¼Œæ‚¨å¯ä»¥è¿›è¡Œè¿ç»­çš„ã€æœ‰ä¸Šä¸‹æ–‡çš„å¯¹è¯ã€‚</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex justify-end mt-6">
                <button id="closeGuideBtn" class="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                    å…³é—­æŒ‡å—
                </button>
            </div>
        </div>
    </div>

    <!-- é¡¶éƒ¨æ ‡é¢˜æ  -->
    <header class="stranger-header py-4 px-6 flex items-center justify-between z-10">
        <div class="flex items-center">
            <div class="w-10 h-10 rounded-full bg-gradient-to-r from-purple-600 to-pink-600 flex items-center justify-center mr-3 shadow-lg pulse-glow">
                <i class="fas fa-robot text-white text-lg"></i>
            </div>
            <h1 class="stranger-title text-xl">å¼‚æ¬¡å…ƒ AI åŠ©æ‰‹</h1>
            <span id="apiStatus" class="ml-2 stranger-badge text-xs font-medium px-2.5 py-0.5 rounded">å·²è¿æ¥</span>
            <span id="contextBadge" class="context-badge">ä¸Šä¸‹æ–‡è®°å¿†</span>
        </div>
        
        <!-- æ—¶é’Ÿå®¹å™¨ -->
        <div class="clock-container">
            <span class="clock-label">å½“å‰æ—¶é—´</span>
            <div id="digitalClock" class="digital-clock"></div>
        </div>
        
        <div class="flex space-x-4">
            <button class="text-gray-400 hover:text-pink-400 transition-colors" id="clearContext" title="æ¸…é™¤ä¸Šä¸‹æ–‡">
                <i class="fas fa-brain"></i>
            </button>
            <button class="text-gray-400 hover:text-pink-400 transition-colors" id="clearChat" title="æ¸…ç©ºå¯¹è¯">
                <i class="fas fa-trash-alt"></i>
            </button>
            <button class="text-gray-400 hover:text-blue-400 transition-colors" id="showGuide" title="ä½¿ç”¨æŒ‡å—">
                <i class="fas fa-question-circle"></i>
            </button>
            <button class="text-gray-400 hover:text-purple-400 transition-colors" id="toggleSettings" title="è®¾ç½®">
                <i class="fas fa-cog"></i>
            </button>
        </div>
    </header>

    <!-- è®¾ç½®é¢æ¿ -->
    <div id="settingsPanel" class="stranger-panel border-b border-gray-700 px-6 py-4 z-10">
        <div class="max-w-3xl mx-auto">
            <h3 class="text-sm font-semibold text-blue-300 mb-3">å¼‚æ¬¡å…ƒè¿æ¥è®¾ç½®</h3>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-300 mb-2">é€‰æ‹© AI æœåŠ¡æä¾›å•†</label>
                <select id="aiProvider" class="w-full stranger-select rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="deepseek">å¼‚æ¬¡å…ƒ AI (æ¨è)</option>
                    <option value="openai">OpenAI</option>
                    <option value="mock">æ¨¡æ‹Ÿæ¨¡å¼</option>
                </select>
            </div>
            
            <div id="deepseekSection" class="mb-4">
                <div class="built-in-key-notice">
                    <i class="fas fa-key mr-1"></i>
                    <strong>å…¬å…±APIå¯†é’¥å·²å¯ç”¨</strong> - æ‰€æœ‰ç”¨æˆ·å‡å¯ä½¿ç”¨æ­¤æœåŠ¡
                </div>
                
                <label class="block text-sm font-medium text-gray-300 mb-2 mt-4">AI æ¨¡å‹</label>
                <select id="deepseekModel" class="w-full stranger-select rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="deepseek-chat">DeepSeek-Chat (æ¨è)</option>
                    <option value="deepseek-reasoner">DeepSeek-Reasoner</option>
                </select>
                
                <div class="model-info">
                    <p class="font-medium text-blue-300 mb-1">ä¸Šä¸‹æ–‡è®°å¿†è®¾ç½®</p>
                    <div class="flex items-center justify-between">
                        <span class="text-gray-400">æœ€å¤§å¯¹è¯è½®æ•°:</span>
                        <span id="contextCount" class="text-blue-300">0</span>
                    </div>
                    <p class="text-gray-400 mt-2">ç³»ç»Ÿä¼šè‡ªåŠ¨ç»´æŠ¤æœ€è¿‘20è½®å¯¹è¯çš„ä¸Šä¸‹æ–‡è®°å¿†ã€‚</p>
                </div>
                
                <div class="rate-limit-notice">
                    <p><i class="fas fa-info-circle text-amber-400 mr-1"></i> <strong>æç¤ºï¼š</strong>ä¸ºä¿éšœæœåŠ¡ç¨³å®šï¼Œç³»ç»Ÿè®¾æœ‰ä½¿ç”¨é¢‘ç‡é™åˆ¶ã€‚</p>
                </div>
            </div>

            <!-- æ·»åŠ ç¼ºå¤±çš„OpenAIè®¾ç½®éƒ¨åˆ† -->
            <div id="openaiSection" class="mb-4 hidden">
                <label class="block text-sm font-medium text-gray-300 mb-2">OpenAI API å¯†é’¥</label>
                <input type="password" id="openaiKey" placeholder="è¾“å…¥æ‚¨çš„ OpenAI API å¯†é’¥" 
                       class="api-key-input w-full rounded-lg px-3 py-2 text-sm focus:outline-none mb-2">
                <label class="block text-sm font-medium text-gray-300 mb-2">OpenAI æ¨¡å‹</label>
                <select id="openaiModel" class="w-full stranger-select rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                    <option value="gpt-4">GPT-4</option>
                </select>
                <p class="text-xs text-gray-500 mt-1">å¦‚éœ€ä½¿ç”¨OpenAIï¼Œè¯·è‡ªè¡Œé…ç½®APIå¯†é’¥</p>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-300 mb-2">API åŸºç¡€ URL</label>
                <input type="text" id="baseUrl" value="https://api.deepseek.com" 
                       class="api-key-input w-full rounded-lg px-3 py-2 text-sm focus:outline-none">
                <p class="text-xs text-gray-500 mt-1">API çš„åŸºç¡€ URL</p>
            </div>
            
            <div class="flex justify-between items-center">
                <button id="testAPI" class="api-test-btn text-white px-4 py-2 rounded-lg text-sm font-medium">
                    æµ‹è¯•è¿æ¥
                </button>
                <button id="saveSettings" class="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                    ä¿å­˜è®¾ç½®
                </button>
            </div>
            
            <div id="testResult" class="mt-4 hidden p-3 rounded-lg text-sm"></div>
        </div>
    </div>

    <!-- èŠå¤©æ¶ˆæ¯æ˜¾ç¤ºåŒº -->
    <main class="flex-1 overflow-y-auto p-4 message-container" id="chatContainer">
        <div class="max-w-3xl mx-auto" id="messageContainer">
            <!-- æ¶ˆæ¯å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
        </div>
    </main>

    <!-- åº•éƒ¨è¾“å…¥æ  -->
    <footer class="stranger-header border-t border-gray-700 p-4">
        <div class="max-w-3xl mx-auto">
            <!-- å›¾ç‰‡é¢„è§ˆåŒºåŸŸ -->
            <div id="imagePreviewContainer" class="image-preview-container mb-3 hidden"></div>
            
            <div class="flex items-center">
                <!-- è¾“å…¥å·¥å…·æŒ‰é’® -->
                <div class="input-tools">
                    <button class="tool-button image-upload-btn" id="imageUploadBtn" title="ä¸Šä¼ å›¾ç‰‡">
                        <i class="fas fa-image"></i>
                    </button>
                    <button class="tool-button voice-btn" id="voiceBtn" title="è¯­éŸ³è¾“å…¥">
                        <i class="fas fa-microphone"></i>
                    </button>
                </div>
                
                <div class="input-container flex-1 rounded-full px-4 py-2 flex items-center transition-all duration-300">
                    <!-- æ–‡æœ¬è¾“å…¥æ¡† -->
                    <input type="text" placeholder="è¾“å…¥æ‚¨çš„æ¶ˆæ¯..." class="bg-transparent border-none focus:outline-none flex-1 py-1 px-2 text-white placeholder-gray-500" id="messageInput">
                </div>
                
                <!-- å‘é€æŒ‰é’® -->
                <button class="send-button text-white rounded-full w-10 h-10 flex items-center justify-center ml-3 shadow-lg" id="sendButton">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
            
            <div class="max-w-3xl mx-auto mt-2 text-xs text-gray-500 text-center fade-in">
                <p>å¼‚æ¬¡å…ƒ AI åŠ©æ‰‹ - æ”¯æŒä¸Šä¸‹æ–‡è®°å¿†çš„æ™ºèƒ½å¯¹è¯</p>
            </div>
        </div>
    </footer>

    <!-- éšè—çš„æ–‡ä»¶è¾“å…¥ -->
    <input type="file" id="fileInput" class="file-input" accept="image/*" multiple>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const chatContainer = document.getElementById('chatContainer');
            const messageContainer = document.getElementById('messageContainer');
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            const clearChatButton = document.getElementById('clearChat');
            const clearContextButton = document.getElementById('clearContext');
            const toggleSettingsButton = document.getElementById('toggleSettings');
            const showGuideButton = document.getElementById('showGuide');
            const settingsPanel = document.getElementById('settingsPanel');
            const aiProviderSelect = document.getElementById('aiProvider');
            const deepseekModelSelect = document.getElementById('deepseekModel');
            const baseUrlInput = document.getElementById('baseUrl');
            const saveSettingsButton = document.getElementById('saveSettings');
            const testAPIButton = document.getElementById('testAPI');
            const testResultDiv = document.getElementById('testResult');
            const apiStatus = document.getElementById('apiStatus');
            const contextBadge = document.getElementById('contextBadge');
            const contextCount = document.getElementById('contextCount');
            const digitalClock = document.getElementById('digitalClock');
            
            // æ–°å¢åŠŸèƒ½å…ƒç´ 
            const imageUploadBtn = document.getElementById('imageUploadBtn');
            const voiceBtn = document.getElementById('voiceBtn');
            const fileInput = document.getElementById('fileInput');
            const imagePreviewContainer = document.getElementById('imagePreviewContainer');
            
            // ä¿®å¤ç¼ºå¤±çš„DOMå…ƒç´ å¼•ç”¨
            const deepseekSection = document.getElementById('deepseekSection');
            const openaiSection = document.getElementById('openaiSection');
            const openaiKeyInput = document.getElementById('openaiKey');
            const openaiModelSelect = document.getElementById('openaiModel');
            
            // æŒ‡å—æ¨¡æ€æ¡†å…ƒç´ 
            const guideModal = document.getElementById('guideModal');
            const closeGuide = document.getElementById('closeGuide');
            const closeGuideBtn = document.getElementById('closeGuideBtn');
            
            // å…¬å…±APIå¯†é’¥
            const PUBLIC_API_KEY = 'sk-5553f687b0e14fa19dac2eec5f0721ff';
            
            // ä¸Šä¸‹æ–‡è®°å¿†è®¾ç½®
            const MAX_CONTEXT_LENGTH = 20; // æœ€å¤§ä¸Šä¸‹æ–‡è½®æ•°
            let conversationHistory = []; // å­˜å‚¨å¯¹è¯å†å²
            
            // åº”ç”¨è®¾ç½®
            let settings = {
                aiProvider: 'deepseek',
                apiKey: PUBLIC_API_KEY,
                baseUrl: 'https://api.deepseek.com',
                deepseekModel: 'deepseek-chat',
                openaiKey: '',
                openaiModel: 'gpt-3.5-turbo'
            };
            
            // è¯­éŸ³è¯†åˆ«
            let recognition = null;
            let isRecording = false;
            let uploadedImages = [];
            
            // ä½¿ç”¨é¢‘ç‡é™åˆ¶
            let requestCount = 0;
            const MAX_REQUESTS_PER_MINUTE = 30;
            let lastResetTime = Date.now();
            
            // æ£€æŸ¥é¢‘ç‡é™åˆ¶
            function checkRateLimit() {
                const now = Date.now();
                if (now - lastResetTime > 60000) {
                    requestCount = 0;
                    lastResetTime = now;
                }
                
                if (requestCount >= MAX_REQUESTS_PER_MINUTE) {
                    throw new Error('è¯·æ±‚é¢‘ç‡è¿‡é«˜ï¼Œè¯·ç¨åå†è¯•ã€‚ä¸ºä¿éšœæœåŠ¡ç¨³å®šï¼Œç³»ç»Ÿè®¾æœ‰ä½¿ç”¨é™åˆ¶ã€‚');
                }
                
                requestCount++;
                return true;
            }
            
            // æ ¹æ®é€‰æ‹©çš„AIæä¾›å•†æ˜¾ç¤º/éšè—ç›¸å…³è®¾ç½®
            function toggleProviderSections() {
                // éšè—æ‰€æœ‰éƒ¨åˆ†
                if (deepseekSection) deepseekSection.style.display = 'none';
                if (openaiSection) openaiSection.style.display = 'none';
                
                // æ˜¾ç¤ºé€‰ä¸­çš„éƒ¨åˆ†
                if (aiProviderSelect.value === 'deepseek') {
                    if (deepseekSection) deepseekSection.style.display = 'block';
                    if (baseUrlInput) baseUrlInput.value = 'https://api.deepseek.com';
                } else if (aiProviderSelect.value === 'openai') {
                    if (openaiSection) openaiSection.style.display = 'block';
                    if (baseUrlInput) baseUrlInput.value = 'https://api.openai.com/v1';
                }
            }
            
            // æ·»åŠ ä¸Šä¸‹æ–‡åˆ°å†å²è®°å½•
            function addToConversationHistory(role, content, images = []) {
                const message = {
                    role: role,
                    content: content,
                    timestamp: new Date().toISOString(),
                    images: [...images]
                };
                
                conversationHistory.push(message);
                
                // é™åˆ¶å†å²è®°å½•é•¿åº¦
                if (conversationHistory.length > MAX_CONTEXT_LENGTH * 2) {
                    conversationHistory = conversationHistory.slice(-MAX_CONTEXT_LENGTH * 2);
                }
                
                // æ›´æ–°ä¸Šä¸‹æ–‡è®¡æ•°æ˜¾ç¤º
                updateContextCount();
                saveConversationHistory();
            }
            
            // æ›´æ–°ä¸Šä¸‹æ–‡è®¡æ•°æ˜¾ç¤º
            function updateContextCount() {
                const userMessages = conversationHistory.filter(msg => msg.role === 'user').length;
                if (contextCount) {
                    contextCount.textContent = `${userMessages}/${MAX_CONTEXT_LENGTH}`;
                }
                
                // æ›´æ–°å¾½ç« é¢œè‰²
                if (contextBadge) {
                    if (userMessages >= MAX_CONTEXT_LENGTH * 0.8) {
                        contextBadge.style.background = 'rgba(244, 67, 54, 0.3)';
                        contextBadge.style.borderColor = 'rgba(244, 67, 54, 0.5)';
                        contextBadge.style.color = '#ef9a9a';
                    } else if (userMessages >= MAX_CONTEXT_LENGTH * 0.5) {
                        contextBadge.style.background = 'rgba(255, 152, 0, 0.3)';
                        contextBadge.style.borderColor = 'rgba(255, 152, 0, 0.5)';
                        contextBadge.style.color = '#ffcc80';
                    } else {
                        contextBadge.style.background = 'rgba(156, 39, 176, 0.3)';
                        contextBadge.style.borderColor = 'rgba(156, 39, 176, 0.5)';
                        contextBadge.style.color = '#ce93d8';
                    }
                }
            }
            
            // ä¿å­˜å¯¹è¯å†å²åˆ°localStorage
            function saveConversationHistory() {
                localStorage.setItem('conversationHistory', JSON.stringify(conversationHistory));
            }
            
            // ä»localStorageåŠ è½½å¯¹è¯å†å²
            function loadConversationHistory() {
                const savedHistory = localStorage.getItem('conversationHistory');
                if (savedHistory) {
                    conversationHistory = JSON.parse(savedHistory);
                    updateContextCount();
                }
            }
            
            // æ¸…é™¤ä¸Šä¸‹æ–‡è®°å¿†
            function clearContext() {
                if (conversationHistory.length > 0) {
                    if (confirm('ç¡®å®šè¦æ¸…é™¤ä¸Šä¸‹æ–‡è®°å¿†å—ï¼ŸAIå°†å¿˜è®°ä¹‹å‰çš„å¯¹è¯å†…å®¹ã€‚')) {
                        conversationHistory = [];
                        saveConversationHistory();
                        updateContextCount();
                        addAiMessage('ä¸Šä¸‹æ–‡è®°å¿†å·²æ¸…é™¤ã€‚æˆ‘ä»¬å¯ä»¥å¼€å§‹æ–°çš„å¯¹è¯äº†ï¼');
                    }
                } else {
                    alert('å½“å‰æ²¡æœ‰ä¸Šä¸‹æ–‡è®°å¿†å¯æ¸…é™¤ã€‚');
                }
            }
            
            // æ„å»ºä¸Šä¸‹æ–‡æ¶ˆæ¯
            function buildContextMessages() {
                const systemMessage = {
                    role: 'system',
                    content: 'ä½ æ˜¯ä¸€ä¸ªæœ‰å¸®åŠ©çš„AIåŠ©æ‰‹ã€‚è¯·ç”¨ä¸­æ–‡å›ç­”ç”¨æˆ·çš„é—®é¢˜ã€‚è®°ä½ä¹‹å‰çš„å¯¹è¯ä¸Šä¸‹æ–‡ï¼Œæä¾›è¿è´¯çš„å›ç­”ã€‚'
                };
                
                return [systemMessage, ...conversationHistory];
            }
            
            // åˆå§‹åŒ–è¯­éŸ³è¯†åˆ«
            function initSpeechRecognition() {
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    recognition = new SpeechRecognition();
                    recognition.continuous = false;
                    recognition.interimResults = false;
                    recognition.lang = 'zh-CN';
                    
                    recognition.onresult = function(event) {
                        const transcript = event.results[0][0].transcript;
                        if (messageInput) messageInput.value = transcript;
                        if (voiceBtn) voiceBtn.classList.remove('recording');
                        isRecording = false;
                    };
                    
                    recognition.onerror = function(event) {
                        console.error('è¯­éŸ³è¯†åˆ«é”™è¯¯:', event.error);
                        if (voiceBtn) voiceBtn.classList.remove('recording');
                        isRecording = false;
                        alert('è¯­éŸ³è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•');
                    };
                    
                    recognition.onend = function() {
                        if (voiceBtn) voiceBtn.classList.remove('recording');
                        isRecording = false;
                    };
                } else {
                    if (voiceBtn) voiceBtn.style.display = 'none';
                    console.warn('æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«');
                }
            }
            
            // æ›´æ–°æ—¶é’Ÿå‡½æ•°
            function updateClock() {
                const now = new Date();
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const seconds = String(now.getSeconds()).padStart(2, '0');
                if (digitalClock) {
                    digitalClock.textContent = `${hours}:${minutes}:${seconds}`;
                }
            }
            
            // åˆå§‹åŒ–æ—¶é’Ÿ
            updateClock();
            setInterval(updateClock, 1000);
            
            // ä»localStorageåŠ è½½è®¾ç½®
            function loadSettings() {
                const savedSettings = localStorage.getItem('aiChatSettings');
                if (savedSettings) {
                    const userSettings = JSON.parse(savedSettings);
                    settings = {
                        ...settings,
                        ...userSettings,
                        apiKey: PUBLIC_API_KEY
                    };
                }
                
                // æ›´æ–°UI
                if (aiProviderSelect) aiProviderSelect.value = settings.aiProvider;
                if (deepseekModelSelect) deepseekModelSelect.value = settings.deepseekModel;
                if (baseUrlInput) baseUrlInput.value = settings.baseUrl;
                if (openaiKeyInput) openaiKeyInput.value = settings.openaiKey;
                if (openaiModelSelect) openaiModelSelect.value = settings.openaiModel;
                
                toggleProviderSections();
                updateAPIStatus();
            }
            
            // ä¿å­˜è®¾ç½®åˆ°localStorage
            function saveSettings() {
                settings.aiProvider = aiProviderSelect ? aiProviderSelect.value : 'deepseek';
                settings.deepseekModel = deepseekModelSelect ? deepseekModelSelect.value : 'deepseek-chat';
                settings.baseUrl = baseUrlInput ? baseUrlInput.value : 'https://api.deepseek.com';
                settings.openaiKey = openaiKeyInput ? openaiKeyInput.value : '';
                settings.openaiModel = openaiModelSelect ? openaiModelSelect.value : 'gpt-3.5-turbo';
                
                localStorage.setItem('aiChatSettings', JSON.stringify(settings));
            }
            
            // æ›´æ–°APIçŠ¶æ€æ˜¾ç¤º
            function updateAPIStatus() {
                if (!apiStatus) return;
                
                if (settings.aiProvider === 'deepseek') {
                    apiStatus.textContent = 'å…¬å…±æœåŠ¡';
                    apiStatus.className = 'ml-2 bg-green-600 text-white text-xs font-medium px-2.5 py-0.5 rounded';
                } else if (settings.aiProvider === 'openai') {
                    apiStatus.textContent = 'OpenAI';
                    apiStatus.className = 'ml-2 bg-green-900 text-green-300 text-xs font-medium px-2.5 py-0.5 rounded';
                } else {
                    apiStatus.textContent = 'æ¨¡æ‹Ÿæ¨¡å¼';
                    apiStatus.className = 'ml-2 bg-gray-700 text-gray-300 text-xs font-medium px-2.5 py-0.5 rounded';
                }
            }
            
            // è·å–å½“å‰æ—¶é—´
            function getCurrentTime() {
                const now = new Date();
                return `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            }
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            function addUserMessage(message, images = []) {
                const messageElement = document.createElement('div');
                messageElement.className = 'user-message mb-6 flex items-start justify-end';
                
                let contentHTML = `<p class="text-white">${message}</p>`;
                
                if (images.length > 0) {
                    contentHTML += '<div class="image-preview-container mt-2">';
                    images.forEach(imgData => {
                        contentHTML += `<img src="${imgData}" alt="ä¸Šä¼ çš„å›¾ç‰‡" class="uploaded-image">`;
                    });
                    contentHTML += '</div>';
                }
                
                contentHTML += `<span class="text-xs text-pink-200 mt-1 block">${getCurrentTime()}</span>`;
                
                messageElement.innerHTML = `
                    <div class="user-bubble message-bubble rounded-2xl rounded-tr-none px-4 py-3 max-w-[85%]">
                        ${contentHTML}
                    </div>
                    <div class="w-8 h-8 rounded-full bg-gradient-to-r from-purple-600 to-pink-600 flex items-center justify-center ml-3 flex-shrink-0 shadow-sm">
                        <i class="fas fa-user text-white text-xs"></i>
                    </div>
                `;
                if (messageContainer) {
                    messageContainer.appendChild(messageElement);
                }
                scrollToBottom();
                
                // æ·»åŠ åˆ°ä¸Šä¸‹æ–‡å†å²
                addToConversationHistory('user', message, images);
            }
            
            // æ·»åŠ AIæ¶ˆæ¯
            function addAiMessage(message, isWelcome = false) {
                const messageElement = document.createElement('div');
                messageElement.className = 'ai-message mb-6 flex items-start';
                messageElement.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-gradient-to-r from-blue-600 to-purple-600 flex items-center justify-center mr-3 flex-shrink-0 shadow-sm">
                        <i class="fas fa-robot text-white text-sm"></i>
                    </div>
                    <div class="ai-bubble message-bubble rounded-2xl rounded-tl-none px-4 py-3 max-w-[85%]">
                        <p class="text-white">${message}</p>
                        <span class="text-xs text-blue-300 mt-1 block">${getCurrentTime()}</span>
                    </div>
                `;
                
                if (isWelcome) {
                    if (messageContainer) {
                        messageContainer.appendChild(messageElement);
                    }
                } else {
                    hideTypingIndicator();
                    if (messageContainer) {
                        messageContainer.appendChild(messageElement);
                    }
                    
                    // æ·»åŠ åˆ°ä¸Šä¸‹æ–‡å†å²
                    addToConversationHistory('assistant', message);
                }
                
                scrollToBottom();
            }
            
            // æ˜¾ç¤ºAIæ­£åœ¨è¾“å…¥
            function showTypingIndicator() {
                const typingElement = document.createElement('div');
                typingElement.className = 'ai-message mb-6 flex items-start';
                typingElement.id = 'typingIndicator';
                typingElement.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-gradient-to-r from-blue-600 to-purple-600 flex items-center justify-center mr-3 flex-shrink-0 shadow-sm">
                        <i class="fas fa-robot text-white text-sm"></i>
                    </div>
                    <div class="ai-bubble message-bubble rounded-2xl rounded-tl-none px-4 py-3 max-w-[85%]">
                        <div class="typing-indicator">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                `;
                if (messageContainer) {
                    messageContainer.appendChild(typingElement);
                }
                scrollToBottom();
            }
            
            // éšè—AIæ­£åœ¨è¾“å…¥
            function hideTypingIndicator() {
                const typingIndicator = document.getElementById('typingIndicator');
                if (typingIndicator) {
                    typingIndicator.remove();
                }
            }
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            function scrollToBottom() {
                if (chatContainer) {
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }
            }
            
            // è·å–å½“å‰APIä¿¡æ¯
            function getCurrentAPIInfo() {
                const provider = aiProviderSelect ? aiProviderSelect.value : 'deepseek';
                let apiKey, model, url;
                
                if (provider === 'deepseek') {
                    apiKey = PUBLIC_API_KEY;
                    model = deepseekModelSelect ? deepseekModelSelect.value : 'deepseek-chat';
                    url = baseUrlInput ? baseUrlInput.value : 'https://api.deepseek.com';
                } else if (provider === 'openai') {
                    apiKey = settings.openaiKey;
                    model = settings.openaiModel;
                    url = baseUrlInput ? baseUrlInput.value : 'https://api.openai.com/v1';
                } else {
                    return { provider: 'mock' };
                }
                
                return { provider, apiKey, model, url };
            }
            
            // å‘é€æ¶ˆæ¯åˆ°AI API
            async function sendMessageToAI(message, images = []) {
                const apiInfo = getCurrentAPIInfo();
                
                if (apiInfo.provider === 'mock') {
                    return new Promise(resolve => {
                        setTimeout(() => {
                            const mockResponses = [
                                "è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é—®é¢˜ï¼åŸºäºæˆ‘ä»¬ä¹‹å‰çš„å¯¹è¯ï¼Œè®©æˆ‘ä¸ºæ‚¨è¯¦ç»†è§£é‡Šä¸€ä¸‹...",
                                "æ ¹æ®æˆ‘çš„ç†è§£å’Œä¹‹å‰çš„ä¸Šä¸‹æ–‡ï¼Œè¿™ä¸ªé—®é¢˜çš„ç­”æ¡ˆæ˜¯...",
                                "æˆ‘å¾ˆé«˜å…´æ‚¨ç»§ç»­è¿™ä¸ªè¯é¢˜ï¼ä»æˆ‘ä»¬ä¹‹å‰çš„è®¨è®ºæ¥çœ‹...",
                                "è¿™æ˜¯ä¸€ä¸ªå¤æ‚çš„è¯é¢˜ï¼Œä½†ç»“åˆæˆ‘ä»¬ä¹‹å‰çš„å¯¹è¯ï¼Œæˆ‘ä¼šå°½åŠ›ä¸ºæ‚¨è§£ç­”...",
                                "æ„Ÿè°¢æ‚¨çš„æé—®ï¼åŸºäºä¸Šä¸‹æ–‡ï¼Œæˆ‘è®¤ä¸ºè¿™ä¸ªé—®é¢˜çš„å…³é”®åœ¨äº..."
                            ];
                            const randomResponse = mockResponses[Math.floor(Math.random() * mockResponses.length)];
                            resolve(randomResponse);
                        }, 1500);
                    });
                }
                
                // æ£€æŸ¥é¢‘ç‡é™åˆ¶
                checkRateLimit();
                
                try {
                    let response;
                    
                    if (apiInfo.provider === 'deepseek' || apiInfo.provider === 'openai') {
                        const contextMessages = buildContextMessages();
                        
                        // æ·»åŠ å½“å‰ç”¨æˆ·æ¶ˆæ¯
                        const currentUserMessage = {
                            role: 'user',
                            content: images.length > 0 ? 
                                `${message}\n\nç”¨æˆ·ä¸Šä¼ äº† ${images.length} å¼ å›¾ç‰‡ï¼Œè¯·æ ¹æ®å›¾ç‰‡å†…å®¹è¿›è¡Œå›ç­”ã€‚` : 
                                message
                        };
                        
                        const requestBody = {
                            model: apiInfo.model,
                            messages: [...contextMessages, currentUserMessage],
                            max_tokens: 4000,
                            temperature: 0.7,
                            stream: false
                        };
                        
                        if (apiInfo.provider === 'deepseek') {
                            requestBody.frequency_penalty = 0;
                            requestBody.presence_penalty = 0;
                            requestBody.top_p = 0.8;
                        }
                        
                        response = await fetch(`${apiInfo.url}/chat/completions`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${apiInfo.apiKey}`
                            },
                            body: JSON.stringify(requestBody)
                        });
                    }
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        let errorMessage = 'APIè¯·æ±‚å¤±è´¥';
                        try {
                            const errorData = JSON.parse(errorText);
                            errorMessage = errorData.error?.message || errorMessage;
                        } catch (e) {
                            errorMessage = `HTTP ${response.status}: ${errorText}`;
                        }
                        throw new Error(errorMessage);
                    }
                    
                    const data = await response.json();
                    
                    if (apiInfo.provider === 'deepseek' || apiInfo.provider === 'openai') {
                        return data.choices[0].message.content;
                    }
                    
                    throw new Error('ä¸æ”¯æŒçš„APIæä¾›å•†');
                } catch (error) {
                    console.error('APIè°ƒç”¨é”™è¯¯:', error);
                    
                    let userFriendlyError = error.message;
                    
                    if (error.message.includes('401')) {
                        userFriendlyError = 'APIå¯†é’¥æ— æ•ˆ';
                    } else if (error.message.includes('429')) {
                        userFriendlyError = 'è¯·æ±‚é¢‘ç‡è¿‡é«˜ï¼Œè¯·ç¨åå†è¯•';
                    } else if (error.message.includes('500')) {
                        userFriendlyError = 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·ç¨åå†è¯•';
                    } else if (error.message.includes('model_not_found')) {
                        userFriendlyError = 'æ‰€é€‰æ¨¡å‹ä¸å¯ç”¨';
                    } else if (error.message.includes('Failed to fetch')) {
                        userFriendlyError = 'ç½‘ç»œè¿æ¥å¤±è´¥';
                    }
                    
                    throw new Error(userFriendlyError);
                }
            }
            
            // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
            function handleImageUpload(event) {
                const files = event.target.files;
                if (files.length === 0) return;
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    if (!file.type.startsWith('image/')) continue;
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const imageData = e.target.result;
                        uploadedImages.push(imageData);
                        
                        const imagePreview = document.createElement('div');
                        imagePreview.className = 'image-preview';
                        imagePreview.innerHTML = `
                            <img src="${imageData}" alt="é¢„è§ˆå›¾ç‰‡" class="uploaded-image">
                            <button class="remove-image" data-index="${uploadedImages.length - 1}">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                        if (imagePreviewContainer) {
                            imagePreviewContainer.appendChild(imagePreview);
                            imagePreviewContainer.classList.remove('hidden');
                        }
                        
                        imagePreview.querySelector('.remove-image').addEventListener('click', function() {
                            const index = parseInt(this.getAttribute('data-index'));
                            uploadedImages.splice(index, 1);
                            imagePreview.remove();
                            
                            const removeButtons = imagePreviewContainer ? imagePreviewContainer.querySelectorAll('.remove-image') : [];
                            removeButtons.forEach((btn, idx) => {
                                btn.setAttribute('data-index', idx);
                            });
                            
                            if (uploadedImages.length === 0 && imagePreviewContainer) {
                                imagePreviewContainer.classList.add('hidden');
                            }
                        });
                    };
                    reader.readAsDataURL(file);
                }
                
                if (fileInput) fileInput.value = '';
            }
            
            // è¯­éŸ³è¾“å…¥å¤„ç†
            function toggleVoiceInput() {
                if (!recognition) {
                    alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«åŠŸèƒ½');
                    return;
                }
                
                if (isRecording) {
                    recognition.stop();
                    if (voiceBtn) voiceBtn.classList.remove('recording');
                    isRecording = false;
                } else {
                    recognition.start();
                    if (voiceBtn) voiceBtn.classList.add('recording');
                    isRecording = true;
                }
            }
            
            // æµ‹è¯•APIè¿æ¥
            async function testAPIConnection() {
                const apiInfo = getCurrentAPIInfo();
                
                if (apiInfo.provider === 'mock') {
                    showTestResult('æ¨¡æ‹Ÿæ¨¡å¼æ— éœ€æµ‹è¯•', 'info');
                    return;
                }
                
                if (testAPIButton) {
                    testAPIButton.disabled = true;
                    testAPIButton.textContent = 'æµ‹è¯•ä¸­...';
                }
                
                try {
                    checkRateLimit();
                    const testMessage = "è¯·å›å¤'æµ‹è¯•æˆåŠŸ'";
                    const response = await sendMessageToAI(testMessage);
                    
                    if (response && response.includes('æµ‹è¯•æˆåŠŸ')) {
                        showTestResult('è¿æ¥æµ‹è¯•æˆåŠŸï¼ä¸Šä¸‹æ–‡è®°å¿†åŠŸèƒ½æ­£å¸¸', 'success');
                    } else {
                        showTestResult('å“åº”å¼‚å¸¸', 'warning');
                    }
                } catch (error) {
                    showTestResult(`è¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                } finally {
                    if (testAPIButton) {
                        testAPIButton.disabled = false;
                        testAPIButton.textContent = 'æµ‹è¯•è¿æ¥';
                    }
                }
            }
            
            // æ˜¾ç¤ºæµ‹è¯•ç»“æœ
            function showTestResult(message, type) {
                if (!testResultDiv) return;
                
                testResultDiv.textContent = message;
                testResultDiv.className = 'mt-4 p-3 rounded-lg text-sm';
                
                if (type === 'success') {
                    testResultDiv.classList.add('test-success');
                } else if (type === 'error') {
                    testResultDiv.classList.add('test-failure');
                } else if (type === 'warning') {
                    testResultDiv.classList.add('bg-yellow-900', 'text-yellow-200');
                } else {
                    testResultDiv.classList.add('bg-blue-900', 'text-blue-200');
                }
                
                testResultDiv.classList.remove('hidden');
            }
            
            // å‘é€æ¶ˆæ¯
            async function sendMessage() {
                const message = messageInput ? messageInput.value.trim() : '';
                if (message === '' && uploadedImages.length === 0) return;
                
                addUserMessage(message || '[å›¾ç‰‡æ¶ˆæ¯]', uploadedImages);
                
                if (messageInput) messageInput.value = '';
                if (imagePreviewContainer) {
                    imagePreviewContainer.innerHTML = '';
                    imagePreviewContainer.classList.add('hidden');
                }
                
                showTypingIndicator();
                
                try {
                    const aiResponse = await sendMessageToAI(message, uploadedImages);
                    addAiMessage(aiResponse);
                    
                    uploadedImages = [];
                } catch (error) {
                    console.error('è·å–AIå“åº”æ—¶å‡ºé”™:', error);
                    hideTypingIndicator();
                    addAiMessage(`æŠ±æ­‰ï¼Œæˆ‘é‡åˆ°äº†ä¸€äº›é—®é¢˜: ${error.message}ã€‚è¯·ç¨åå†è¯•ã€‚`);
                }
            }
            
            // æ¸…ç©ºèŠå¤©
            function clearChat() {
                if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰èŠå¤©è®°å½•å—ï¼Ÿè¿™å°†æ¸…é™¤æ‰€æœ‰æ¶ˆæ¯å’Œä¸Šä¸‹æ–‡è®°å¿†ã€‚')) {
                    if (messageContainer) messageContainer.innerHTML = '';
                    conversationHistory = [];
                    uploadedImages = [];
                    if (imagePreviewContainer) {
                        imagePreviewContainer.innerHTML = '';
                        imagePreviewContainer.classList.add('hidden');
                    }
                    saveConversationHistory();
                    updateContextCount();
                    addAiMessage("æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„å¼‚æ¬¡å…ƒ AI åŠ©æ‰‹ã€‚ç³»ç»Ÿå·²æ¸…ç©ºæ‰€æœ‰å¯¹è¯è®°å½•ï¼Œæˆ‘ä»¬å¯ä»¥å¼€å§‹å…¨æ–°çš„å¯¹è¯äº†ï¼", true);
                }
            }
            
            // ä¿å­˜è®¾ç½®
            function saveSettingsToStorage() {
                saveSettings();
                updateAPIStatus();
                
                if (settingsPanel) settingsPanel.classList.remove('open');
                
                alert('è®¾ç½®å·²ä¿å­˜ï¼');
            }
            
            // æ˜¾ç¤ºæŒ‡å—
            function showGuide() {
                if (guideModal) guideModal.classList.add('open');
            }
            
            // éšè—æŒ‡å—
            function hideGuide() {
                if (guideModal) guideModal.classList.remove('open');
            }
            
            // åˆ‡æ¢è®¾ç½®é¢æ¿æ˜¾ç¤º/éšè—
            function toggleSettingsPanel() {
                if (settingsPanel) settingsPanel.classList.toggle('open');
            }
            
            // äº‹ä»¶ç›‘å¬
            if (sendButton) sendButton.addEventListener('click', sendMessage);
            
            if (messageInput) {
                messageInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
            }
            
            if (clearChatButton) clearChatButton.addEventListener('click', clearChat);
            if (clearContextButton) clearContextButton.addEventListener('click', clearContext);
            
            if (toggleSettingsButton) toggleSettingsButton.addEventListener('click', toggleSettingsPanel);
            
            if (showGuideButton) showGuideButton.addEventListener('click', showGuide);
            
            if (aiProviderSelect) aiProviderSelect.addEventListener('change', function() {
                toggleProviderSections();
                updateAPIStatus();
            });
            
            if (saveSettingsButton) saveSettingsButton.addEventListener('click', saveSettingsToStorage);
            
            if (testAPIButton) testAPIButton.addEventListener('click', testAPIConnection);
            
            if (closeGuide) closeGuide.addEventListener('click', hideGuide);
            if (closeGuideBtn) closeGuideBtn.addEventListener('click', hideGuide);
            
            // æ–°å¢åŠŸèƒ½äº‹ä»¶ç›‘å¬
            if (imageUploadBtn) {
                imageUploadBtn.addEventListener('click', function() {
                    if (fileInput) fileInput.click();
                });
            }
            
            if (fileInput) fileInput.addEventListener('change', handleImageUpload);
            
            if (voiceBtn) voiceBtn.addEventListener('click', toggleVoiceInput);
            
            // åˆå§‹åŒ–è¯­éŸ³è¯†åˆ«
            initSpeechRecognition();
            
            // åˆå§‹åŒ–
            loadSettings();
            loadConversationHistory();
            addAiMessage("æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„å¼‚æ¬¡å…ƒ AI åŠ©æ‰‹ï¼Œå·²è¿æ¥åˆ° DeepSeek AI æ¨¡å‹ã€‚æˆ‘å…·å¤‡ä¸Šä¸‹æ–‡è®°å¿†åŠŸèƒ½ï¼Œå¯ä»¥è®°ä½æˆ‘ä»¬ä¹‹å‰çš„å¯¹è¯å†…å®¹ã€‚ç³»ç»Ÿä½¿ç”¨å…¬å…±APIå¯†é’¥ï¼Œæ‰€æœ‰ç”¨æˆ·å‡å¯å…è´¹ä½¿ç”¨ã€‚æˆ‘æ”¯æŒæ–‡æœ¬å¯¹è¯ã€å›¾ç‰‡åˆ†æå’Œè¯­éŸ³è¾“å…¥åŠŸèƒ½ã€‚æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®åŠ©æ‚¨çš„å—ï¼Ÿ", true);
        });
    </script>
</body>
</html>
